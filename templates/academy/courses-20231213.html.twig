{% extends template_layout_name %}

{% block content %}

    <section class="academy_enterprise__page">
        <div class="bg_circle_left"></div>
        <div class="bg_rectangle_left"><img src="/static/images/enterprise_left.58e9531.svg" alt=""></div>
        <div class="bg_rectangle_right"><img src="/static/images/enterprise_right.e8293ab.svg" alt=""></div>
        <div class="bg_circle_right"><img src="/static/images/credential_right.a13c81c.svg" alt=""></div>
        <div class="container">

            <div class="breadcrumb m-b-80">
                <ol>
                    {% include('layouts/breadcrumb.html.twig') %}
                </ol>
            </div>
            <h1 id="academyType" class="m-b-40">{{ ret['academyType'] }}</h1>
            <div class="popupcover"></div>
            <div class="row">
                <div class="col-lg-4">
                    <div class="filter filter-menu mobile">
                        <div class="filter-warp hide">
                            <div class="filter_head">
                                <div class="filter_head_title">
                                    <div class="icon_mobile">
                                        <img src="/static/images/filter.cd48788.svg" alt=""></div>
                                    <div class="text">Filter</div>
                                </div>
                                <div class="filter_head_clear">Clear</div>
                            </div>
                            <div class="filter_body">
                                <div class="filter_item">
                                    <select onchange="getOptions()" class="js-search-basic-single hide-search" id="type" name="type" autocomplete="off">
                                        <option selected disabled value="default">Type</option>
                                        {% for type in ret['eventType'] %}
                                            <option value="{{ type['key'] }}">{{ type['value'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter_item">
                                    <select onchange="getOptions()" class="js-search-basic-single hide-search" id="level" name="level" autocomplete="off">
                                        <option selected disabled value="default" >Level</option>
                                        {% for level in ret['level'] %}
                                            <option value="{{ level['key'] }}">{{ level['value'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter_item">
                                    <select onchange="getOptions()" class="js-example-basic-single list-flex" id="topic" name="topic"autocomplete="off">
                                        <option selected disabled value="default">Topic</option>
                                        {% for topic in ret['topic'] %}
                                            <option value="{{ topic['key'] }}">{{ topic['value'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
								<div class="filter_item">
                                    <select onchange="getOptions()" class="js-search-basic-single hide-search" id="fee" name="fee" autocomplete="off">
                                        <option selected disabled value="default">Fee</option>
                                        {% for level in ret['fee'] %}
                                            <option value="{{ level['key'] }}">{{ level['value'] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="filter_item">
                                    <div class="datepicker" id="datepicker"></div>
                                    <input type="hidden" name="date" id="my_hidden_input">
                                </div>
                            </div>
                            <div class="filter_footer">
                                <div class="btn border_orange btn-cancel">Cancel</div>
                                <div class="btn full_orange">Apply Filter</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-8">
                    <div class="course_result"><span>courses</span></div>
                    <div class="course_content">

                    </div>
                </div>
            </div>
            <div class="space-60"></div>
        </div>
    </section>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="/static/static/js/bootstrap-datepicker.min.js" integrity="sha512-T/tUfKSV1bihCnd+MxKD0Hm1uBBroVYBOYSk1knyvQ9VyZJpc/ALb4P0r6ubwVPSGB2GvjeoMAJJImBG12TiaQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        let selectDate;
        viewLst(selectDate);

        function timeFormat(time) {
            timeArray = time.split(":");

            if (timeArray[0] < 12) {
                return timeArray[0] + ":" + timeArray[1] + " am";
            }

            if (timeArray[0] == 12 && Number(timeArray[1]) == 0) {
                return timeArray[0] + ":" + timeArray[1] + " am";
            }

            if (
                timeArray[0] == 12 &&
                Number(timeArray[1]) > 0 &&
                Number(timeArray[1]) < 60
            ) {
                return timeArray[0] + ":" + timeArray[1] + " pm";
            }

            if (timeArray[0] > 12 && timeArray[0] < 24) {
                return timeArray[0] - 12 + ":" + timeArray[1] + " pm";
            }
        }

        function viewLst(filter = {}, selectDate = "") {
            filter.academyType = $("#academyType").text();
            filter = JSON.stringify(filter);

            $.ajax({
                url: "/api/getCourses",

                data: { filter: filter, filterDate: selectDate },
                type: "POST",
                success: function (result) {
                    console.log("test");
                    console.log("result");
                    $(".course_result").html(result.total + "<span>results</span>");
                    var listItem = "";
                    $.each(result.data, function (key, element) {
                        var coverImg = "";

                        if (element.coverImage != "") {
                            coverImg =
                                '<img class="cover" src="' + element.coverImage + '" alt="">';
                        }

                        var dateStr = "";
                        var contentLeft = "";
                        var venueStr = element.venue;
                        if (element.venueText) {
                            venueStr = element.venueText;
                        }

                        if (element.planningStr != null) {
                            var tbcCount = 0;
                            element.planningStr.forEach(function (planning) {
                                var timeStr = "";
                                if (planning.teachingArrangement != null) {
                                    var total = planning.teachingArrangement.length;
                                    planning.teachingArrangement.forEach(function (
                                        teachingArrangement,
                                        index
                                    ) {
                                        var timeTbcCount = 0;
                                        if (
                                            teachingArrangement.startTime != "" &&
                                            teachingArrangement.lastTime != ""
                                        ) {
                                            if (timeStr != "") {
                                                timeStr += " , ";
                                            }
                                            timeStr += '<div class="time-row">';
                                            timeStr += '<div class="time">';
                                            timeStr +=
                                                '<div class="text">' +
                                                teachingArrangement.startTime +
                                                " - " +
                                                teachingArrangement.lastTime +
                                                "</div>";
                                            timeStr += "</div>";
                                            timeStr += "</div>";

                                            timeTbcCount++;
                                        } else {
                                            if (timeStr == "") {
                                                timeStr = '<div class="text">TBC</div>';
                                            }
                                            timeTbcCount++;
                                        }

                                        if (teachingArrangement.venue != "") {
                                            venueStr = teachingArrangement.venue;
                                            if (teachingArrangement.venueText !== null) {
                                                venueStr += " - ";
                                                venueStr += teachingArrangement.venueText;
                                            }
                                        }
                                    });
                                }

                                if (planning.startDate != "") {
                                    var startDate = new Date(planning.startDate);
                                    if (planning.lastDate != "") {
                                        var lastDate = new Date(planning.lastDate);
                                        if (startDate.getMonth() == lastDate.getMonth()) {
                                            dateStr +=
                                                '<div class="content_date_day-com">' +
                                                '<div class="date">' +
                                                startDate.getDate() +
                                                "-" +
                                                lastDate.getDate() +
                                                "</div>" +
                                                '<div class="month-year">' +
                                                startDate.toLocaleString("en-US", { month: "short" }) +
                                                " " +
                                                startDate.getFullYear() +
                                                "</div>" +
                                                timeStr +
                                                "</div>";
                                            contentLeft +=
                                                '<div class="content_place" style="flex-direction:column;margin-bottom:15px">' +
                                                '<div class="icon" style="position: absolute"><img src="/static/images/place.21274f4.svg" alt=""></div>' +
                                                '<div class="text" style="margin-left: 15px; font-weight: 500">' +
                                                startDate.getDate() +
                                                "-" +
                                                lastDate.getDate() +
                                                " " +
                                                startDate.toLocaleString("en-US", { month: "short" }) +
                                                "</div>" +
                                                '<div class="text" style="margin-left: 15px">' +
                                                venueStr +
                                                "</div>" +
                                                "</div>";
                                        } else {
                                            dateStr +=
                                                '<div class="content_date_day-com">' +
                                                '<div class="date">' +
                                                startDate.getDate() +
                                                " " +
                                                startDate.toLocaleString("en-US", { month: "short" }) +
                                                " - " +
                                                lastDate.getDate() +
                                                " " +
                                                lastDate.toLocaleString("en-US", { month: "short" }) +
                                                "</div>" +
                                                '<div class="month-year">' +
                                                startDate.getFullYear() +
                                                "</div>" +
                                                timeStr +
                                                "</div>";
                                            contentLeft +=
                                                '<div class="content_place" style="flex-direction:column;margin-bottom:15px">' +
                                                '<div class="icon" style="position: absolute"><img src="/static/images/place.21274f4.svg" alt=""></div>' +
                                                '<div class="text" style="margin-left: 15px; font-weight: 500">' +
                                                startDate.getDate() +
                                                " " +
                                                startDate.toLocaleString("en-US", { month: "short" }) +
                                                " - " +
                                                lastDate.getDate() +
                                                " " +
                                                lastDate.toLocaleString("en-US", { month: "short" }) +
                                                "</div>" +
                                                '<div class="text" style="margin-left: 15px">' +
                                                venueStr +
                                                "</div>" +
                                                "</div>";
                                        }
                                    } else {
                                        dateStr +=
                                            '<div class="content_date_day-com">' +
                                            '<div class="date">' +
                                            startDate.getDate() +
                                            "</div>" +
                                            '<div class="month-year">' +
                                            startDate.toLocaleString("en-US", { month: "short" }) +
                                            " " +
                                            startDate.getFullYear() +
                                            "</div>" +
                                            timeStr +
                                            "</div>";

                                        contentLeft +=
                                            '<div class="content_place" style="flex-direction:column;margin-bottom:15px">' +
                                            '<div class="icon" style="position: absolute"><img src="/static/images/place.21274f4.svg" alt=""></div>' +
                                            '<div class="text" style="margin-left: 15px; font-weight: 500">' +
                                            startDate.getDate() +
                                            " " +
                                            startDate.toLocaleString("en-US", { month: "short" }) +
                                            "</div>" +
                                            '<div class="text" style="margin-left: 15px">' +
                                            venueStr +
                                            "</div>" +
                                            "</div>";
                                    }
                                    tbcCount++;
                                } else {
                                    if (tbcCount < 1) {
                                        dateStr +=
                                            '<div class="content_date_day-com">' +
                                            '<div class="date">TBC</div>' +
                                            "</div>";
                                    }
                                    tbcCount++;
                                }
                            });
                        } else {
                            dateStr +=
                                '<div class="content_date_day">TBC</div>' +
                                '<div class="space-20"></div>';
                        }

                        listItem +=
                            '<div class="course_content_item">' +
                            '<div class="course_content_item_left">' +
                            '<div class="course_content_item_left_image"><a href="' +
                            element.fullpath +
                            "_" +
                            element.id +
                            ' ">' +
                            coverImg +
                            "</a></div></div>" +
                            '<div class="course_content_item_center">' +
                            '<div class="content_top">' +
                            '<div class="content_tag">' +
                            '<div class="content_tag_item">' +
                            element.eventType +
                            "</div>" +
                            '<div class="content_tag_item">' +
                            element.level +
                            "</div>" +
                            '</div><a class="content_title nocut" href="' +
                            element.fullpath +
                            "_" +
                            element.id +
                            ' ">' +
                            element.title +
                            "</a></div>" +
                            '<div class="content_bottom">' +
                            contentLeft +
                            "</div></div>" +
                            '<div class="course_content_item_right">' +
                            '<div class="content_date">' +
                            dateStr +
                            "</div>" +
                            "</div></div>";
                    });

                    $(".course_content").html(listItem);
                },
            });
        }

        function getOptions(dateTime = "") {
            var type = $("#type").val();
            var topic = $("#topic").val();
            var level = $("#level").val();
            var fee = $("#fee").val();

            var filter = {};

            if (type) {
                filter.eventType = type;
            }
            if (topic) {
                filter.topic = topic;
            }

            if (level) {
                filter.level = level;
            }
            if (fee) {
                filter.fee = fee;
            }
            this.getPicker(filter);
            this.viewLst(filter, dateTime);
        }

        $(".js-example-basic-single").select2();
        $(".js-search-basic-single.hide-search").select2({
            minimumResultsForSearch: Infinity,
        });

        $(".js-example-basic-single").on("select2:select", function (e) {
            // 做点什么
            console.log(e.params.data);
        });
        $(".js-search-basic-single.hide-search").on("select2:select", function (e) {
            // 做点什么
            console.log(e.params.data);
        });
        let eventArr = [];

        getPicker({});

        function getPicker(filter) {
            filter.academyType = $("#academyType").text();
            var filter = JSON.stringify(filter);
            $.ajax({
                url: "/api/getPicker",
                type: "POST",
                data: { filter: filter },
                success: function (result) {
                    console.log("Result ", result);
                    if (result) {
                        eventArr = [];
                        $.each(result, function (index, date) {
                            eventArr.push(new Date(date).toDateString());
                        });
                    }
                    successFunction();
                    console.log("Event Array ", eventArr);
                    console.log("Calendar dates have been updated.");
                },
            });
        }

        function successFunction() {
            // $('#datepicker').datepicker('destroy');
            $("#datepicker").datepicker({
                todayHighlight: true,
                templates: {
                    leftArrow: '<i"></i>',
                    rightArrow: '<i"></i>',
                },
                beforeShowDay: function (date) {
                    if (eventArr.includes(date.toDateString())) {
                        return {
                            enabled: true,
                            classes: "event1",
                            tooltip: "We have events on these days",
                        };
                    }
                    return true;
                },
            });
            // $('#datepicker').datepicker('refresh');
        }

        $("#datepicker").on("changeDate", function () {
            $("#my_hidden_input").val($("#datepicker").datepicker("getFormattedDate"));
            selectDate = new Date($("#my_hidden_input").val()).getTime();

            getOptions(selectDate);
        });

        // jQuery(function(){
        // jQuery('.today.day').click();
        // console.log('finish loadd')
        // });

        $(".datepicker thead .prev").text("");
        $(".datepicker thead .next").text("");

        $(".filter.filter-menu .filter_head").on("click", function (e) {
            if ($(e.target).hasClass("filter_head_clear")) {
                return;
            }
            var windowsize = $(window).width();
            if (windowsize <= 768) {
                if ($(".filter.mobile .filter-warp").hasClass("hide")) {
                    $(".filter.mobile .filter-warp").removeClass("hide");
                    $(".filter.mobile .filter-warp").addClass("active");
                    $(".classnames, .popupcover").addClass("active");
                } else {
                    $(".filter.mobile .filter-warp").removeClass("active").addClass("hide");
                    $(".filter.mobile .filter_head").addClass("active");
                    $(".classnames, .popupcover").removeClass("active");
                }
            }
        });
        $(".filter.filter-menu .btn-cancel").on("click", function (e) {
            $(".filter.mobile .filter-warp").removeClass("active").addClass("hide");
            $(".classnames, .popupcover").removeClass("active");
        });

        $(".filter.mobile  .filter_head .filter_head_clear").click(function () {
            $("#datepicker").datepicker("clearDates");
            $(".js-example-basic-single").val("default");
            $(".js-search-basic-single.hide-search").val("default");
            $(".js-example-basic-single").trigger("change");
            $(".js-search-basic-single.hide-search").trigger("change");
        });
        $(".filter .filter_head .filter_head_clear").on("click", function () {
            $("#datepicker").datepicker("clearDates");
            $(".js-example-basic-single").val("default");
            $(".js-search-basic-single.hide-search").val("default");
            $(".js-example-basic-single").trigger("change");
            $(".js-search-basic-single.hide-search").trigger("change");
        });
        $(".filter.mobile .btn-cancel").on("click", function () {
            if (windowsize <= 768) {
                if ($(".filter.mobile").hasClass("active")) {
                    $(".filter.mobile").removeClass("active");
                    $(".filter.mobile").addClass("hide");
                }
            }
        });
    </script>

{% endblock %}
